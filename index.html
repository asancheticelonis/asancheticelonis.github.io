<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Wings App</title>
    <!-- Tailwind CSS CDN - Not recommended for production, but convenient for single file demos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for in-browser JSX transformation - VERY IMPORTANT for this setup -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Basic Spinner CSS for loading state */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Mock Lucide Icons ---
        // Since direct 'import { Icon } from "lucide-react";' won't work in a single HTML file
        // without a build process, we're providing simple SVG placeholder functions for the icons
        // used in the application. In a standard React project, you would install and import
        // lucide-react normally.
        const MockIcon = ({ size = 24, className = '', children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Leaf = (props) => <MockIcon {...props}><path d="M11 20A7 7 0 0 1 9.86 6.76C4.65 6.53 2 11.23 2 13a6 6 0 0 0 12 0c0-1.23-.5-2.23-1.4-3.14"></path><path d="M15 16s4.5-2.5 7-7c-2.5-4.5-7-7-7-7-2.9-1.3-4.9-3.3-6.1-5.6"></path></MockIcon>;
        const Plane = (props) => <MockIcon {...props}><path d="M17.8 19.2 16 11.2V9l3-3 2 2-3 3h3l2 2v1.5L18.8 22H4.2L2 19.2l1.5-1.5L6 17v-3l2-2h2l1 1h4.2l1.6 1.6 1.4 1.4Z"></path><path d="M9 11l-3 3"></path><path d="M15 11l3 3"></path></MockIcon>;
        const Train = (props) => <MockIcon {...props}><path d="M2 17h20"></path><path d="M14 10V6a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"></path><path d="M18 10h4"></path><path d="M2 10h4"></path><path d="M7 17l-3 4"></path><path d="M17 17l3 4"></path><path d="M10 17l-3 4"></path><path d="M14 17l3 4"></path></MockIcon>;
        const Car = (props) => <MockIcon {...props}><path d="M19 17H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2z"></path><circle cx="7" cy="13" r="1.5"></circle><circle cx="17" cy="13" r="1.5"></circle></MockIcon>;
        const Star = (props) => <MockIcon {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></MockIcon>;
        const Trophy = (props) => <MockIcon {...props}><path d="M12 12H7.5V6H12v6Z"></path><path d="M12 12h4.5v6H12v-6Z"></path><path d="M12 12V2H4v10a4 4 0 0 0 4 4h4Z"></path><path d="M12 12V2h8v10a4 4 0 0 1-4 4h-4Z"></path><path d="M4 18h16"></path><path d="M5 22h14"></path></MockIcon>;
        const BarChart = (props) => <MockIcon {...props}><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></MockIcon>;
        const User = (props) => <MockIcon {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></MockIcon>;
        const LogOut = (props) => <MockIcon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="17 16 22 12 17 8"></polyline><line x1="22" y1="12" x2="10" y2="12"></line></MockIcon>;
        const ChevronDown = (props) => <MockIcon {...props}><polyline points="6 9 12 15 18 9"></polyline></MockIcon>;
        const ChevronUp = (props) => <MockIcon {...props}><polyline points="18 15 12 9 6 15"></polyline></MockIcon>;
        const CheckCircle = (props) => <MockIcon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></MockIcon>;
        const PlusCircle = (props) => <MockIcon {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></MockIcon>;
        const CalendarDays = (props) => <MockIcon {...props}><path d="M8 2v4"></path><path d="M16 2v4"></path><rect x="3" y="4" width="18" height="18" rx="2"></rect><path d="M3 10h18"></path><path d="M8 14h.01"></path><path d="M16 14h.01"></path><path d="M12 18h.01"></path></MockIcon>;

        const { useState, useEffect, createContext, useContext } = React;

        // --- Context for State Management ---
        const AppContext = createContext();

        // Mock Data - In a real app, this would come from a database (e.g., Firestore)
        const MOCK_USER = {
          name: 'Alex Rinke',
          email: 'alex.green@example.com',
          team: 'Co-CEO',
          greenPoints: 1250,
          badges: ['First Flight', 'Eco-Explorer', '500kg CO2 Saver'],
          travelHistory: [
            { id: 1, from: 'New York', to: 'London', mode: 'Plane', emissions: 1800, points: 50, date: '2024-05-10', flightDetails: { airline: 'BA', flightNumber: 112 } },
            { id: 2, from: 'New York', to: 'Washington D.C.', mode: 'Train', emissions: 50, points: 200, date: '2024-04-22' },
            { id: 3, from: 'New York', to: 'Boston', mode: 'Train', emissions: 45, points: 200, date: '2024-03-15' },
          ],
        };

        const MOCK_LEADERBOARD = [
          { name: 'Sarah Jenkins', team: 'Business Development', greenPoints: 1800 },
          { name: 'Alex Rinke', team: 'Co-CEO', greenPoints: 1250 },
          { name: 'Tom Wilson', team: 'Value Engineering', greenPoints: 1100 },
          { name: 'Maria Garcia', team: 'Value Engineering', greenPoints: 950 },
          { name: 'Chen Liu', team: 'Business Development', greenPoints: 800 },
        ];

        const MOCK_COMPANY_DATA = {
          totalEmissionsSaved: 15700, // in kg CO2e
          sustainableTrips: 112,
          emissionsByMode: [
            { name: 'Flights', value: 65 },
            { name: 'Trains', value: 25 },
            { name: 'Cars', value: 10 },
          ],
        };

        // --- Main App Component ---
        function App() {
          const [page, setPage] = useState('dashboard');
          const [user, setUser] = useState(MOCK_USER);
          const [leaderboard, setLeaderboard] = useState(MOCK_LEADERBOARD);
          const [companyData, setCompanyData] = useState(MOCK_COMPANY_DATA);
          const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

          const navigate = (pageName) => {
            setPage(pageName);
            setIsMobileMenuOpen(false);
          };

          const addTrip = (trip) => {
            setUser(prevUser => {
              const updatedUser = {
                ...prevUser,
                greenPoints: prevUser.greenPoints + trip.points,
                travelHistory: [trip, ...prevUser.travelHistory],
              };

              setLeaderboard(prevLeaderboard => {
                const userIndex = prevLeaderboard.findIndex(u => u.name === updatedUser.name);
                let newLeaderboard = [...prevLeaderboard];
                if (userIndex !== -1) {
                  newLeaderboard[userIndex].greenPoints = updatedUser.greenPoints;
                } else {
                  newLeaderboard.push({ name: updatedUser.name, team: updatedUser.team, greenPoints: updatedUser.greenPoints });
                }
                return newLeaderboard.sort((a, b) => b.greenPoints - a.greenPoints);
              });
              
              setCompanyData(prevData => ({
                ...prevData,
                totalEmissionsSaved: prevData.totalEmissionsSaved + (2000 - trip.emissions), // Assuming a baseline of 2000kg for a similar trip
                sustainableTrips: trip.emissions < 500 ? prevData.sustainableTrips + 1 : prevData.sustainableTrips,
                emissionsByMode: prevData.emissionsByMode.map(modeData => {
                  if (modeData.name.toLowerCase() === trip.mode.toLowerCase()) {
                    const newValue = modeData.value + 1; 
                    return { ...modeData, value: newValue > 100 ? 100 : newValue }; 
                  }
                  return modeData;
                })
              }));

              return updatedUser;
            });
          };

          const appContextValue = { user, leaderboard, companyData, navigate, addTrip };

          return (
            <AppContext.Provider value={appContextValue}>
              <div className="bg-gray-50 min-h-screen font-sans text-gray-800">
                <Header onMenuToggle={() => setIsMobileMenuOpen(!isMobileMenuOpen)} />
                <div className="flex">
                  <Sidebar navigate={navigate} currentPage={page} isMobileMenuOpen={isMobileMenuOpen} />
                  <main className="flex-1 p-4 sm:p-6 lg:p-8 transition-all duration-300">
                    {page === 'dashboard' && <Dashboard />}
                    {page === 'log' && <LogTripPage />}
                    {page === 'leaderboard' && <Leaderboard />}
                    {page === 'profile' && <Profile />}
                  </main>
                </div>
              </div>
            </AppContext.Provider>
          );
        }

        // --- Components ---

        function Header({ onMenuToggle }) {
          const { user } = useContext(AppContext);
          return (
            <header className="bg-white shadow-sm sticky top-0 z-20">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex justify-between items-center h-16">
                  <div className="flex items-center">
                    <Leaf className="h-8 w-8 text-green-600" />
                    <h1 className="text-xl sm:text-2xl font-bold text-gray-800 ml-2">Green Wings</h1>
                  </div>
                  <div className="hidden md:flex items-center space-x-4">
                    <div className="flex items-center">
                      <Leaf className="h-5 w-5 text-green-500 mr-1" />
                      <span className="font-semibold text-green-600">{user.greenPoints} Points</span>
                    </div>
                    <div className="flex items-center">
                      <User className="h-5 w-5 text-gray-500 mr-1" />
                      <span className="font-medium">{user.name}</span>
                    </div>
                    <button className="flex items-center text-gray-500 hover:text-gray-700">
                      <LogOut className="h-5 w-5" />
                    </button>
                  </div>
                  <div className="md:hidden">
                    <button onClick={onMenuToggle} className="text-gray-500 hover:text-gray-700">
                      <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </header>
          );
        }

        function Sidebar({ navigate, currentPage, isMobileMenuOpen }) {
          const NavItem = ({ icon, label, pageName }) => (
            <button
              onClick={() => navigate(pageName)}
              className={`flex items-center w-full px-4 py-3 text-left text-sm font-medium rounded-lg transition-colors duration-150 ${
                currentPage === pageName
                  ? 'bg-green-100 text-green-700'
                  : 'text-gray-600 hover:bg-gray-100 hover:text-gray-800'
              }`}
            >
              {icon}
              <span className="ml-3">{label}</span>
            </button>
          );

          return (
            <>
              <aside className={`fixed md:relative z-10 md:z-auto bg-white md:bg-transparent w-64 md:w-56 flex-shrink-0 p-4 transition-transform duration-300 ease-in-out ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0`}>
                <nav className="space-y-2">
                  <NavItem icon={<BarChart size={20} />} label="Dashboard" pageName="dashboard" />
                  <NavItem icon={<PlusCircle size={20} />} label="Log a Trip" pageName="log" />
                  <NavItem icon={<Trophy size={20} />} label="Leaderboard" pageName="leaderboard" />
                  <NavItem icon={<User size={20} />} label="Profile" pageName="profile" />
                </nav>
              </aside>
              {isMobileMenuOpen && <div className="fixed inset-0 bg-black bg-opacity-50 z-0 md:hidden" onClick={() => navigate(currentPage)}></div>}
            </>
          );
        }

        function Dashboard() {
          const { companyData, leaderboard } = useContext(AppContext);
          
          return (
            <div className="space-y-6">
              <h2 className="text-3xl font-bold text-gray-800">Company Dashboard</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <Card>
                  <CardHeader>
                    <Leaf className="text-green-500" />
                    <CardTitle>Total Emissions Saved</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-4xl font-bold text-green-600">{companyData.totalEmissionsSaved.toLocaleString()}</p>
                    <p className="text-sm text-gray-500">kg CO₂e</p>
                  </CardContent>
                </Card>
                <Card>
                  <CardHeader>
                    <CheckCircle className="text-blue-500" />
                    <CardTitle>Sustainable Trips</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-4xl font-bold text-blue-600">{companyData.sustainableTrips}</p>
                    <p className="text-sm text-gray-500">Trips taken with low-emission options</p>
                  </CardContent>
                </Card>
                <Card>
                   <CardHeader>
                    <Trophy className="text-yellow-500" />
                    <CardTitle>Top Performer</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-2xl font-bold text-yellow-600">{leaderboard[0].name}</p>
                    <p className="text-sm text-gray-500">{leaderboard[0].team}</p>
                  </CardContent>
                </Card>
              </div>
              <Card>
                <CardHeader>
                  <BarChart className="text-purple-500" />
                  <CardTitle>Emissions by Travel Mode (%)</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="w-full h-64">
                      <div className="w-full h-full flex items-end space-x-4">
                        {companyData.emissionsByMode.map(mode => (
                          <div key={mode.name} className="flex-1 flex flex-col items-center">
                            <div className="w-full bg-gray-200 rounded-t-lg" style={{height: `${mode.value}%`}}>
                               <div className="bg-purple-500 h-full w-full rounded-t-lg"></div>
                            </div>
                            <span className="text-xs text-gray-600 mt-1">{mode.name}</span>
                          </div>
                        ))}
                      </div>
                  </div>
                </CardContent>
              </Card>
            </div>
          );
        }

        function LogTripPage() {
            // API Configuration - WARNING: Exposing API keys directly in client-side code is a security risk.
            // For production, use a backend server to proxy API calls and secure your key.
            const GOOGLE_TIM_API_KEY = "AIzaSyDUPNj4b3ljOBMnYmHHzdFhiQkvKeMwGIE"; 
            const GOOGLE_TIM_API_URL = `https://travelimpactmodel.googleapis.com/v1/flights:computeFlightEmissions?key=${GOOGLE_TIM_API_KEY}`;
            
            const [fromIata, setFromIata] = useState(''); // Stores selected IATA code
            const [toIata, setToIata] = useState('');     // Stores selected IATA code
            const [date, setDate] = useState('');
            const [mode, setMode] = useState('Plane');
            const [manualEmissions, setManualEmissions] = useState(''); // For Train/Car
            const [airline, setAirline] = useState('');
            const [flightNumber, setFlightNumber] = useState('');
            const [calculatedEmissions, setCalculatedEmissions] = useState(null); // Stores API result
            const [isLoading, setIsLoading] = useState(false); // For emissions calculation
            const [apiError, setApiError] = useState(null);
            const [showConfirmation, setShowConfirmation] = useState(false);
            const [loggedTrip, setLoggedTrip] = useState(null);
            const { addTrip, navigate } = useContext(AppContext);

            // Set default date to today for the date input
            useEffect(() => {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const dd = String(today.getDate()).padStart(2, '0');
                setDate(`${yyyy}-${mm}-${dd}`);
            }, []);

            // Reset calculated emissions and error when mode changes
            useEffect(() => {
                setCalculatedEmissions(null);
                setApiError(null);
            }, [mode]);

            const calculateFlightEmissions = async () => {
                setApiError(null);
                setCalculatedEmissions(null); // Clear previous calculation
                
                if (!fromIata || !toIata || !airline || !flightNumber || !date) {
                    setApiError("Please fill in Origin Airport (IATA), Destination Airport (IATA), Airline Code, Flight Number, and Departure Date to calculate emissions.");
                    return;
                }

                const departureDateObj = new Date(date);
                if (isNaN(departureDateObj.getTime())) {
                    setApiError("Invalid departure date.");
                    return;
                }

                setIsLoading(true);
                try {
                    const requestBody = {
                        flights: [{
                            origin: fromIata.toUpperCase(),
                            destination: toIata.toUpperCase(),
                            operatingCarrierCode: airline.toUpperCase(),
                            flightNumber: parseInt(flightNumber, 10),
                            departureDate: { 
                                year: departureDateObj.getFullYear(), 
                                month: departureDateObj.getMonth() + 1,
                                day: departureDateObj.getDate() 
                            }
                        }]
                    };

                    const response = await fetch(GOOGLE_TIM_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `API Error: ${response.status}`);
                    }

                    const result = await response.json();
                    const flightResult = result.flightEmissions[0];

                    if (flightResult && flightResult.emissionsGramsPerPax) {
                        // Prioritize economy, then premium, then business, then first
                        const emissionsGrams = flightResult.emissionsGramsPerPax.economy || 
                                               flightResult.emissionsGramsPerPax.premiumEconomy || 
                                               flightResult.emissionsGramsPerPax.business || 
                                               flightResult.emissionsGramsPerPax.first;
                        
                        if (emissionsGrams) {
                            setCalculatedEmissions(Math.round(emissionsGrams / 1000)); // Convert to kg and round
                        } else {
                            setApiError('No specific cabin class emissions data found for this flight. Try a different flight or date.');
                        }
                    } else {
                        setApiError('Emissions data could not be computed for this flight. This can happen if the flight is not found, the date is incorrect, or the aircraft type is not supported by the model.');
                    }

                } catch (error) {
                    console.error("Error calling Travel Impact Model API:", error);
                    setApiError(`Calculation failed: ${error.message}. Please check flight details and try again.`);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                setApiError(null); // Clear any previous API errors

                let emissionsToLog = 0;
                let flightDetailsToLog = null;

                if (mode === 'Plane') {
                    if (calculatedEmissions === null) {
                        // If mode is plane and emissions not calculated, trigger calculation
                        calculateFlightEmissions();
                        return; // Stop here, wait for calculation
                    }
                    emissionsToLog = calculatedEmissions;
                    flightDetailsToLog = { airline, flightNumber: parseInt(flightNumber, 10), origin: fromIata, destination: toIata };
                } else {
                    // For Train/Car, use manual emissions
                    const parsedManualEmissions = parseInt(manualEmissions, 10);
                    if (isNaN(parsedManualEmissions) || parsedManualEmissions < 0) {
                        setApiError("Please enter a valid positive number for emissions for Train/Car trips.");
                        return;
                    }
                    emissionsToLog = parsedManualEmissions;
                }

                if (!fromIata || !toIata || !date || !mode || emissionsToLog === 0) { // Check for 0 emissions after calculation/manual input
                    setApiError("Please fill in all required trip details and ensure emissions are calculated or entered.");
                    return;
                }

                // Calculate points based on emissions. More points for lower emissions.
                const calculatedPoints = Math.max(10, 500 - Math.floor(emissionsToLog / 5));

                const newTrip = {
                    id: Date.now(),
                    from: fromIata, // Log IATA code
                    to: toIata,     // Log IATA code
                    date,
                    mode,
                    emissions: emissionsToLog,
                    points: calculatedPoints,
                    ...(mode === 'Plane' && { flightDetails: flightDetailsToLog }),
                };
                
                setLoggedTrip(newTrip);
                setShowConfirmation(true);
            };

            const handleConfirmLog = () => {
                addTrip(loggedTrip);
                setShowConfirmation(false);
                // Reset form
                setFromIata('');
                setToIata('');
                setDate(''); // Will be reset by useEffect to today's date
                setMode('Plane');
                setManualEmissions('');
                setAirline('');
                setFlightNumber('');
                setCalculatedEmissions(null);
                setApiError(null);
                // Navigate to profile to see the update
                navigate('profile');
            };
            
            return (
                <div className="space-y-6 max-w-2xl mx-auto">
                    <h2 className="text-3xl font-bold text-gray-800">Log Your Trip</h2>
                    <p className="text-gray-600">Enter the details of a completed trip to log your emissions and earn Green Points.</p>
                    <Card>
                        <form onSubmit={handleSubmit}>
                            <CardContent className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Origin Airport (IATA)</label>
                                        <input 
                                            type="text" 
                                            placeholder="e.g., JFK" 
                                            value={fromIata} 
                                            onChange={e => {setFromIata(e.target.value.toUpperCase()); setCalculatedEmissions(null);}} 
                                            required 
                                            className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-green-500 uppercase" 
                                            maxLength="3"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Destination Airport (IATA)</label>
                                        <input 
                                            type="text" 
                                            placeholder="e.g., LHR" 
                                            value={toIata} 
                                            onChange={e => {setToIata(e.target.value.toUpperCase()); setCalculatedEmissions(null);}} 
                                            required 
                                            className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-green-500 uppercase" 
                                            maxLength="3"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Date of Travel</label>
                                    <input type="date" value={date} onChange={e => {setDate(e.target.value); setCalculatedEmissions(null);}} required className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-green-500" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Mode of Travel</label>
                                    <select value={mode} onChange={e => setMode(e.target.value)} required className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-green-500 bg-white">
                                        <option value="Plane">Plane</option>
                                        <option value="Train">Train</option>
                                        <option value="Car">Car</option>
                                    </select>
                                </div>

                                {mode === 'Plane' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                        <p className="col-span-full text-blue-800 font-semibold mb-2">Flight Details</p>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Airline Code (IATA)</label>
                                            <input type="text" placeholder="e.g., UA" value={airline} onChange={e => {setAirline(e.target.value.toUpperCase()); setCalculatedEmissions(null);}} required={mode === 'Plane'} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 uppercase" maxLength="2" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Flight Number</label>
                                            <input type="number" placeholder="e.g., 1777" value={flightNumber} onChange={e => {setFlightNumber(e.target.value); setCalculatedEmissions(null);}} required={mode === 'Plane'} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" min="1" />
                                        </div>
                                        {calculatedEmissions !== null && (
                                            <div className="col-span-full mt-2 p-3 bg-green-100 text-green-800 rounded-lg text-center font-bold text-lg">
                                                Calculated Emissions: {calculatedEmissions} kg CO₂e
                                            </div>
                                        )}
                                        {apiError && (
                                            <div className="col-span-full mt-2 p-3 bg-red-100 text-red-800 rounded-lg text-center text-sm">
                                                {apiError}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {mode !== 'Plane' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Total Emissions (kg CO₂e)</label>
                                        <input type="number" placeholder="e.g., 50" value={manualEmissions} onChange={e => setManualEmissions(e.target.value)} required={mode !== 'Plane'} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-green-500" min="0" />
                                    </div>
                                )}
                            </CardContent>
                            <div className="p-4 bg-gray-50 border-t">
                                <button type="submit" className="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center text-lg" disabled={isLoading}>
                                    {isLoading ? (
                                        <div className="spinner mr-2"></div>
                                    ) : (
                                        <>
                                            {mode === 'Plane' && calculatedEmissions === null ? (
                                                <> <Leaf className="mr-2" /> Calculate Emissions </>
                                            ) : (
                                                <> <PlusCircle className="mr-2" /> Log Trip </>
                                            )}
                                        </>
                                    )}
                                </button>
                            </div>
                        </form>
                    </Card>
                    
                    {showConfirmation && loggedTrip && (
                        <Modal onClose={() => setShowConfirmation(false)}>
                            <h3 className="text-2xl font-bold mb-4">Trip Logged!</h3>
                            <div className="my-4 p-4 bg-gray-100 rounded-lg space-y-2">
                                <p><strong>Route:</strong> {loggedTrip.from} to {loggedTrip.to}</p>
                                <p><strong>Mode:</strong> {loggedTrip.mode}</p>
                                {loggedTrip.mode === 'Plane' && loggedTrip.flightDetails && (
                                    <p><strong>Flight:</strong> {loggedTrip.flightDetails.airline} {loggedTrip.flightDetails.flightNumber}</p>
                                )}
                                <p><strong>Emissions:</strong> {loggedTrip.emissions} kg CO₂e</p>
                                <div className="pt-2 mt-2 border-t">
                                    <p className="text-lg font-bold text-green-600">You've earned {loggedTrip.points} Green Points!</p>
                                </div>
                            </div>
                            <div className="flex justify-end">
                                   <button onClick={handleConfirmLog} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Great!</button>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        }

        function Leaderboard() {
          const { leaderboard } = useContext(AppContext);
          return (
            <div className="space-y-6">
              <h2 className="text-3xl font-bold text-gray-800">Leaderboard</h2>
              <Card>
                <CardContent>
                  <ul className="divide-y divide-gray-200">
                    {leaderboard.map((person, index) => (
                      <li key={person.name} className="p-4 flex items-center justify-between">
                        <div className="flex items-center">
                          <span className={`text-lg font-bold w-8 text-center ${index < 3 ? 'text-yellow-600' : 'text-gray-500'}`}>{index + 1}</span>
                          <div className="ml-2">
                            <p className="font-semibold text-gray-800">{person.name}</p>
                            <p className="text-sm text-gray-500">{person.team}</p>
                          </div>
                        </div>
                        <div className="flex items-center font-bold text-green-600">
                          <Leaf size={16} className="mr-1" />
                          {person.greenPoints.toLocaleString()}
                        </div>
                      </li>
                    ))}
                  </ul>
                </CardContent>
              </Card>
            </div>
          );
        }

        function Profile() {
          const { user } = useContext(AppContext);
          return (
            <div className="space-y-6">
              <h2 className="text-3xl font-bold text-gray-800">My Profile</h2>
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-1 space-y-6">
                  <Card>
                    <CardContent className="flex flex-col items-center text-center p-6">
                      <div className="w-24 h-24 rounded-full bg-green-200 flex items-center justify-center mb-4">
                        <User size={48} className="text-green-600" />
                      </div>
                      <h3 className="text-2xl font-bold">{user.name}</h3>
                      <p className="text-gray-500">{user.team} Team</p>
                      <div className="mt-4 bg-green-100 text-green-800 font-bold py-2 px-4 rounded-full flex items-center">
                        <Leaf size={16} className="mr-2" />
                        {user.greenPoints.toLocaleString()} Green Points
                      </div>
                    </CardContent>
                  </Card>
                  <Card>
                    <CardHeader>
                      <Trophy className="text-yellow-500" />
                      <CardTitle>My Badges</CardTitle>
                    </CardHeader>
                    <CardContent>
                      <div className="flex flex-wrap gap-2">
                        {user.badges.map(badge => (
                          <span key={badge} className="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">{badge}</span>
                        ))}
                      </div>
                    </CardContent>
                  </Card>
                </div>
                <div className="lg:col-span-2">
                  <Card>
                    <CardHeader>
                      <Plane className="text-blue-500" />
                      <CardTitle>My Travel History</CardTitle>
                    </CardHeader>
                    <CardContent>
                      <ul className="divide-y divide-gray-200">
                        {user.travelHistory.map(trip => (
                          <li key={trip.id} className="py-3 grid grid-cols-3 gap-2 items-center">
                            <div>
                              <p className="font-semibold">{trip.from} to {trip.to}</p>
                              <p className="text-sm text-gray-500">{trip.date}</p>
                              {trip.mode === 'Plane' && trip.flightDetails && (
                                <p className="text-xs text-gray-400">Flight: {trip.flightDetails.airline} {trip.flightDetails.flightNumber}</p>
                              )}
                            </div>
                            <div className="text-center">
                              <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                trip.mode === 'Train' ? 'bg-green-100 text-green-800' : trip.mode === 'Plane' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                              }`}>
                                {trip.mode}
                              </span>
                            </div>
                            <div className="text-right">
                              <p className="font-semibold">{trip.emissions} kg CO₂e</p>
                              <p className="text-sm text-green-600">+{trip.points} points</p>
                            </div>
                          </li>
                        ))}
                      </ul>
                    </CardContent>
                  </Card>
                </div>
              </div>
            </div>
          );
        }

        // --- UI Helper Components ---
        const Card = ({ children }) => <div className="bg-white rounded-xl shadow-md overflow-hidden">{children}</div>;
        const CardHeader = ({ children }) => <div className="p-4 border-b border-gray-200 flex items-center space-x-3">{children}</div>;
        const CardTitle = ({ children }) => <h3 className="text-lg font-semibold text-gray-700">{children}</h3>;
        const CardContent = ({ children, className }) => <div className={`p-4 ${className || ''}`}>{children}</div>;

        const Modal = ({ children, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
                <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                    <div className="p-6">
                        {children}
                    </div>
                </div>
            </div>
        );

        // Render the App component
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
